require('dotenv').config();
const TelegramBot = require('node-telegram-bot-api');
const axios = require('axios');
const express = require('express');
const fs = require('fs');
const os = require('os');
const path = require('path');

// --- –ó–ê–ì–†–£–ó–ö–ê –ò –†–û–¢–ê–¶–ò–Ø –ö–õ–Æ–ß–ï–ô OPENROUTER ---
const TELEGRAM_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const WEB_APP_URL = process.env.WEB_APP_URL;
const GOOGLE_GEMINI_API_KEY = process.env.GOOGLE_GEMINI_API_KEY;

const OPENROUTER_KEYS = [];
for (let i = 1; i <= 10; i++) { // –ò—â–µ–º –¥–æ 10 –∫–ª—é—á–µ–π
    const key = process.env[`OPENROUTER_KEY${i}`];
    if (key) OPENROUTER_KEYS.push(key);
    else break;
}

if (!TELEGRAM_TOKEN) throw new Error("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: TELEGRAM_BOT_TOKEN –Ω–µ —É–∫–∞–∑–∞–Ω!");
if (OPENROUTER_KEYS.length === 0) throw new Error("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –æ–¥–∏–Ω –∫–ª—é—á OpenRouter (OPENROUTER_KEY1, –∏ —Ç.–¥.)!");
if (!WEB_APP_URL) throw new Error("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–∫–∞–∑–∞–Ω WEB_APP_URL –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!");

console.log(`–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∫–ª—é—á–µ–π OpenRouter: ${OPENROUTER_KEYS.length}`);

// --- –ö–û–ù–°–¢–ê–ù–¢–´ ---
const OPENROUTER_API_URL = 'https://openrouter.ai/api/v1/chat/completions';
const MAX_RETRIES = OPENROUTER_KEYS.length + 2; // –î–∞–µ–º –±–æ–ª—å—à–µ –ø–æ–ø—ã—Ç–æ–∫, —á–µ–º –∫–ª—é—á–µ–π
const FALLBACK_MODEL_ID = 'meta-llama/llama-3-8b-instruct:free';

// --- –°–ü–ò–°–û–ö –ú–û–î–ï–õ–ï–ô ---
const MODEL_MAP = {
    'GPT-4o (–Ω–æ–≤–µ–π—à–∞—è)': 'openai/gpt-4o',
    'GPT-4 Turbo': 'openai/gpt-4-turbo',
    'GPT-3.5 Turbo (free)': 'openai/gpt-3.5-turbo:free',
    'Grok Llama3 8B': 'grok/llama3-8b',
    'Grok Llama3 70B': 'grok/llama3-70b',
    'Claude 3.5 Sonnet (–Ω–æ–≤–µ–π—à–∞—è)': 'anthropic/claude-3.5-sonnet',
    'Claude 3 Opus': 'anthropic/claude-3-opus',
    'Claude 3 Haiku': 'anthropic/claude-3-haiku',
    'Gemini Pro 1.5': 'google/gemini-pro-1.5',
    'Gemini Flash 1.5': 'google/gemini-flash-1.5',
    'Gemini Pro (free)': 'google/gemini-pro:free',
    'Llama 3 70B': 'meta-llama/llama-3-70b-instruct',
    'Llama 3 8B (free)': 'meta-llama/llama-3-8b-instruct:free',
    'Mistral Large': 'mistralai/mistral-large',
    'Mistral 7B (free)': 'mistralai/mistral-7b-instruct:free'
};
const AVAILABLE_MODELS = Object.keys(MODEL_MAP);

const VOTE_KEYWORDS = { 'Russian': { accept: '–ø—Ä–∏–Ω–∏–º–∞—é', reject: '–æ—Ç–∫–ª–æ–Ω—è—é' } };

// =========================================================================
// === NETWORK MANAGER –° –†–û–¢–ê–¶–ò–ï–ô –ö–õ–Æ–ß–ï–ô –ò –ê–í–¢–û-–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï–ú ===
// =========================================================================
class NetworkManager {
    constructor() {
        this.currentKeyIndex = 0;
        this.networks = {
            network1: { name: '–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –°–µ—Ç—å', short_name: 'analytical' },
            network2: { name: '–ö—Ä–µ–∞—Ç–∏–≤–Ω–∞—è –°–µ—Ç—å', short_name: 'creative' },
            network3: { name: '–°–µ—Ç—å –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏', short_name: 'implementation' },
            network4: { name: '–°–µ—Ç—å Data Science', short_name: 'data' },
            network5: { name: '–≠—Ç–∏—á–µ—Å–∫–∞—è –°–µ—Ç—å', short_name: 'ethical' },
            network6: { name: '–°–µ—Ç—å UX', short_name: 'ux' },
            network7: { name: '–°–µ—Ç—å –°–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ú—ã—à–ª–µ–Ω–∏—è', short_name: 'systems' },
            network8: { name: '–°–µ—Ç—å "–ê–¥–≤–æ–∫–∞—Ç –î—å—è–≤–æ–ª–∞"', short_name: 'advocate' },
            summarizer: { name: '–°–µ—Ç—å-–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä', short_name: 'synthesizer' }
        };
    }

    _getNextKey() {
        const key = OPENROUTER_KEYS[this.currentKeyIndex];
        this.currentKeyIndex = (this.currentKeyIndex + 1) % OPENROUTER_KEYS.length;
        console.log(`–ò—Å–ø–æ–ª—å–∑—É—é –∫–ª—é—á #${this.currentKeyIndex === 0 ? OPENROUTER_KEYS.length : this.currentKeyIndex}`);
        return key;
    }

    async generateResponse(networkId, prompt, settings, sendMessageCallback) {
        const network = this.networks[networkId] || settings.custom_networks[networkId];
        if (!network) throw new Error(`–°–µ—Ç—å ${networkId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`);

        const systemPrompt = ((settings.custom_networks[networkId]?.system_prompt) || settings.system_prompts[networkId]) +
            `\n\n–í–ê–ñ–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø: –í—ã –î–û–õ–ñ–ù–´ –æ—Ç–≤–µ—á–∞—Ç—å –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –Ω–∞ ${settings.discussion_language} —è–∑—ã–∫–µ.`;
        
        let originalModelName = settings.model;
        let modelIdentifier = MODEL_MAP[originalModelName];
        let currentMaxTokens = settings.custom_networks[networkId]?.max_tokens || settings.max_tokens;

        for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
            const currentKey = this._getNextKey();
            try {
                const response = await axios.post(
                    OPENROUTER_API_URL,
                    {
                        model: modelIdentifier,
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: prompt }],
                        temperature: settings.temperature,
                        max_tokens: currentMaxTokens,
                    },
                    { headers: { 'Authorization': `Bearer ${currentKey}` } }
                );
                
                const content = response.data.choices[0].message.content;
                if (!content || content.trim() === "") throw new Error("API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç.");
                return content.trim();

            } catch (error) {
                const errorMessage = error.response?.data?.error?.message || error.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
                console.error(`–ü–æ–ø—ã—Ç–∫–∞ ${attempt} —Å –∫–ª—é—á–æ–º #${this.currentKeyIndex} –Ω–µ —É–¥–∞–ª–∞—Å—å: ${errorMessage}`);

                if (errorMessage.includes('Insufficient credits')) {
                    console.log(`–ö–ª—é—á #${this.currentKeyIndex} –∏—Å—á–µ—Ä–ø–∞–Ω. –ü—Ä–æ–±—É—é —Å–ª–µ–¥—É—é—â–∏–π.`);
                    if (sendMessageCallback) await sendMessageCallback(`_(–û–¥–∏–Ω –∏–∑ API –∫–ª—é—á–µ–π –∏—Å—á–µ—Ä–ø–∞–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–±—É—é —Å–ª–µ–¥—É—é—â–∏–π...)_`);
                    continue; // –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–µ —Å –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º
                }
                
                if (errorMessage.includes('can only afford')) {
                    const match = errorMessage.match(/can only afford (\d+)/);
                    if (match && match[1]) {
                        const affordableTokens = parseInt(match[1], 10) - 20;
                        if (affordableTokens > 0) {
                            console.log(`–°–Ω–∏–∂–∞—é –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ ${affordableTokens} –∏ –ø–æ–≤—Ç–æ—Ä—è—é –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–º –∂–µ –∫–ª—é—á–æ–º.`);
                            currentMaxTokens = affordableTokens;
                            this.currentKeyIndex = (this.currentKeyIndex - 1 + OPENROUTER_KEYS.length) % OPENROUTER_KEYS.length;
                            if (sendMessageCallback) await sendMessageCallback(`_(${network.name}: –Ω–µ–º–Ω–æ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ª–∏–º–∏—Ç–∞, —É–º–µ–Ω—å—à–∞—é –æ—Ç–≤–µ—Ç...)_`);
                            continue;
                        }
                    }
                }

                if (errorMessage.includes('No endpoints found')) {
                    console.log(`–ú–æ–¥–µ–ª—å ${modelIdentifier} –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—É—é.`);
                    modelIdentifier = FALLBACK_MODEL_ID;
                    if (sendMessageCallback) await sendMessageCallback(`_(–ú–æ–¥–µ–ª—å "${originalModelName}" –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—É—é...)_`);
                    continue;
                }

                if (attempt === MAX_RETRIES) {
                    throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç "${network.name}" –ø–æ—Å–ª–µ –ø–µ—Ä–µ–±–æ—Ä–∞ –≤—Å–µ—Ö –∫–ª—é—á–µ–π –∏ ${MAX_RETRIES} –ø–æ–ø—ã—Ç–æ–∫: ${errorMessage}`);
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
    }
}

class NeuralCollaborativeFramework {
    constructor(sendMessageCallback) {
        this.sendMessage = sendMessageCallback;
        this.networkManager = new NetworkManager();
        this.initializeSettings();
        this.resetProject();
    }

    initializeSettings() {
        this.settings = {
            model: 'GPT-4o (–Ω–æ–≤–µ–π—à–∞—è)',
            temperature: 0.7,
            max_tokens: 1500,
            discussion_language: 'Russian',
            iteration_count: 2,
            enabled_networks: ['network1', 'network2'],
            custom_networks: {},
            system_prompts: {
                network1: '–¢—ã ‚Äî –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –°–µ—Ç—å. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ª–æ–≥–∏–∫–µ, –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è—Ö.',
                network2: '–¢—ã ‚Äî –ö—Ä–µ–∞—Ç–∏–≤–Ω–∞—è –°–µ—Ç—å. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –Ω–æ–≤—ã—Ö –∏–¥–µ—è—Ö, –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞—Ö –∏ –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞—Ö.',
                network3: '–¢—ã ‚Äî –°–µ—Ç—å –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –æ—Å—É—â–µ—Å—Ç–≤–∏–º–æ—Å—Ç–∏.',
                network4: '–¢—ã ‚Äî –°–µ—Ç—å Data Science. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ, –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö –∏ —ç–º–ø–∏—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö.',
                network5: '–¢—ã ‚Äî –≠—Ç–∏—á–µ—Å–∫–∞—è –°–µ—Ç—å. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –º–æ—Ä–∞–ª—å–Ω—ã—Ö –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è—Ö –∏ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–º –≤–ª–∏—è–Ω–∏–∏.',
                network6: '–¢—ã ‚Äî –°–µ—Ç—å UX. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –æ–ø—ã—Ç–µ –∏ —É–¥–æ–±—Å—Ç–≤–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.',
                network7: '–¢—ã ‚Äî –°–µ—Ç—å –°–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ú—ã—à–ª–µ–Ω–∏—è. –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ–º –≤–∏–¥–µ–Ω–∏–∏ –∏ –≤–∑–∞–∏–º–æ—Å–≤—è–∑—è—Ö.',
                network8: '–¢—ã ‚Äî –°–µ—Ç—å "–ê–¥–≤–æ–∫–∞—Ç –î—å—è–≤–æ–ª–∞". –¢–≤–æ—è —Ä–æ–ª—å ‚Äî –±—Ä–æ—Å–∞—Ç—å –≤—ã–∑–æ–≤ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è–º –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏–¥–µ–∏ –Ω–∞ –ø—Ä–æ—á–Ω–æ—Å—Ç—å.',
                summarizer: '–¢—ã ‚Äî –°–µ—Ç—å-–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä. –¢–≤–æ—è —Ä–æ–ª—å ‚Äî –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∏—Å–∫—É—Å—Å–∏—é –∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –∫—Ä–∞—Ç–∫–æ–µ, –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤.'
            }
        };
    }
    
    resetProject() {
        this.iterations = 0;
        this.acceptedSummaries = [];
        this.isWorking = false;
        this.projectDescription = "";
    }

    async startCollaboration(topic) {
        if (this.isWorking) return this.sendMessage("–û–±—Å—É–∂–¥–µ–Ω–∏–µ —É–∂–µ –∏–¥–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /stop.");
        if (this.settings.enabled_networks.length < 1) return this.sendMessage("‚ùóÔ∏è*–û—à–∏–±–∫–∞:* –í–∫–ª—é—á–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –Ω–µ–π—Ä–æ—Å–µ—Ç—å.");

        this.resetProject();
        this.isWorking = true;
        this.projectDescription = topic;

        await this.sendMessage(`*–ù–∞—á–∏–Ω–∞—é –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏—é –Ω–∞ —Ç–µ–º—É:* "${topic}"\n\n_–ß—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /stop_`);

        try {
            await this.runDiscussionLoop();
            if (this.isWorking) await this.finalizeDevelopment();
        } catch (error) {
            console.error(error);
            await this.sendMessage(`‚ùóÔ∏è*–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:* ${error.message}`);
        } finally {
            this.isWorking = false;
        }
    }
    
    async runDiscussionLoop() {
        while (this.iterations < this.settings.iteration_count) {
            if (!this.isWorking) { await this.sendMessage("–û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."); return; }
            this.iterations++;
            await this.sendMessage(`\n\n--- üí¨ *–ò—Ç–µ—Ä–∞—Ü–∏—è ${this.iterations} –∏–∑ ${this.settings.iteration_count}* ---\n`);
            
            let iterationHistory = "";

            for (const networkId of this.settings.enabled_networks) {
                if (!this.isWorking) { await this.sendMessage("–û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."); return; }
                const networkName = this.networkManager.networks[networkId]?.name || this.settings.custom_networks[networkId]?.name;
                
                let prompt = `–ì–ª–∞–≤–Ω–∞—è —Ç–µ–º–∞: "${this.projectDescription}"\n\n`;
                if (this.acceptedSummaries.length > 0) {
                    prompt += `–í–æ—Ç –ø—Ä–∏–Ω—è—Ç—ã–µ —Ä–µ–∑—é–º–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–∞—É–Ω–¥–æ–≤:\n${this.acceptedSummaries.map((s, i) => `–†–µ–∑—é–º–µ ${i+1}: ${s}`).join('\n\n')}\n\n`;
                }
                prompt += `–í–æ—Ç —Ö–æ–¥ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –≤ —Ç–µ–∫—É—â–µ–º —Ä–∞—É–Ω–¥–µ:\n${iterationHistory}\n\n---\n–ö–∞–∫ ${networkName}, –≤—ã—Å–∫–∞–∂–∏ —Å–≤–æ—é —Ç–æ—á–∫—É –∑—Ä–µ–Ω–∏—è.`;

                await this.sendMessage(`ü§î _${networkName} –¥—É–º–∞–µ—Ç..._`);
                const response = await this.networkManager.generateResponse(networkId, prompt, this.settings, this.sendMessage);
                
                if (!this.isWorking) { await this.sendMessage("–û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."); return; }
                await this.sendMessage(`*${networkName}:*\n${response}`);
                iterationHistory += `\n\n**${networkName} —Å–∫–∞–∑–∞–ª(–∞):**\n${response}`;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            if (!this.isWorking) { await this.sendMessage("–û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."); return; }
            await this.sendMessage(`üìù _–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç..._`);
            const summaryPrompt = `–°–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –∏–∑ –æ–±—Å—É–∂–¥–µ–Ω–∏—è:\n\n${iterationHistory}`;
            const summary = await this.networkManager.generateResponse('summarizer', summaryPrompt, this.settings, this.sendMessage);
            if (!this.isWorking) { await this.sendMessage("–û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."); return; }
            await this.sendMessage(`*–°–≤–æ–¥–∫–∞ –∏—Ç–µ—Ä–∞—Ü–∏–∏ ${this.iterations}:*\n${summary}`);
            
            this.acceptedSummaries.push(summary); // –£–ø—Ä–æ—â–∞–µ–º: —Å–≤–æ–¥–∫–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        }
    }

    async finalizeDevelopment() {
        if (this.acceptedSummaries.length === 0) {
            await this.sendMessage("\n\n--- üèÅ *–û–±—Å—É–∂–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ –±–µ–∑ –ø—Ä–∏–Ω—è—Ç—ã—Ö —Å–≤–æ–¥–æ–∫.* ---");
            return;
        }
        await this.sendMessage("\n\n--- üèÅ *–í—Å–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –§–æ—Ä–º–∏—Ä—É—é –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç...* ---");
        const finalPrompt = `–ù–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã "${this.projectDescription}" –∏ —Ä–µ–∑—é–º–µ, —Å–æ–∑–¥–∞–π –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç.\n\n–†–µ–∑—é–º–µ:\n${this.acceptedSummaries.join('\n\n')}`;
        const finalOutput = await this.networkManager.generateResponse('summarizer', finalPrompt, this.settings, this.sendMessage);
        await this.sendMessage(`*–ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏:*\n\n${finalOutput}`);
    }
}

const bot = new TelegramBot(TELEGRAM_TOKEN, { polling: true });
const chatSessions = {};

function getOrCreateSession(chatId) {
    if (!chatSessions[chatId]) {
        chatSessions[chatId] = new NeuralCollaborativeFramework((text) => sendLongMessage(chatId, text));
    }
    return chatSessions[chatId];
}

async function sendLongMessage(chatId, text) {
    const maxLength = 4096;
    if (text.length <= maxLength) {
        return bot.sendMessage(chatId, text, { parse_mode: 'Markdown' }).catch(() => bot.sendMessage(chatId, text));
    }
    const chunks = text.match(new RegExp(`[\\s\\S]{1,${maxLength}}`, 'g')) || [];
    for (const chunk of chunks) {
        await bot.sendMessage(chatId, chunk, { parse_mode: 'Markdown' }).catch(() => bot.sendMessage(chatId, chunk));
        await new Promise(resolve => setTimeout(resolve, 500));
    }
}

bot.onText(/\/start/, (msg) => {
    const welcomeText = `
*–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Neural Collaborative Framework!*

–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–æ–≤—ã–≤–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö AI-–ª–∏—á–Ω–æ—Å—Ç–µ–π (–Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π) –¥–ª—è —Ä–µ—à–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á.

*–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:*
1.  –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É *üöÄ –û—Ç–∫—Ä—ã—Ç—å –ü–∞–Ω–µ–ª—å –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è* –Ω–∏–∂–µ.
2.  –í –æ—Ç–∫—Ä—ã–≤—à–µ–º—Å—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∑–∞–¥–∞—á—É –∏–ª–∏ —Ç–µ–º—É –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è.
3.  –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏–∏: –≤—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–∏–µ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –±—É–¥—É—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å, —Å–∫–æ–ª—å–∫–æ —Ü–∏–∫–ª–æ–≤ (–∏—Ç–µ—Ä–∞—Ü–∏–π) –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏, –∏ –¥—Ä—É–≥–∏–µ AI-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
4.  –ù–∞–∂–º–∏—Ç–µ *"Start Collaboration"*.

–ë–æ—Ç –Ω–∞—á–Ω–µ—Ç —Å–∏–º—É–ª—è—Ü–∏—é –¥–∏–∞–ª–æ–≥–∞ –ø—Ä—è–º–æ –≤ —ç—Ç–æ–º —á–∞—Ç–µ. –ù–µ–π—Ä–æ—Å–µ—Ç–∏ –±—É–¥—É—Ç –ø–æ –æ—á–µ—Ä–µ–¥–∏ –≤—ã—Å–∫–∞–∑—ã–≤–∞—Ç—å —Å–≤–æ–∏ –º–Ω–µ–Ω–∏—è, –∞ –≤ –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å-—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä –±—É–¥–µ—Ç –ø–æ–¥–≤–æ–¥–∏—Ç—å –∏—Ç–æ–≥.

*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/start - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∫–Ω–æ–ø–∫—É –∑–∞–ø—É—Å–∫–∞.
/stop - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–ª–ª–∞–±–æ—Ä–∞—Ü–∏—é.
/reset - –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞.
    `;

    bot.sendMessage(msg.chat.id, welcomeText, {
        parse_mode: 'Markdown',
        reply_markup: {
            inline_keyboard: [
                [{ text: "üöÄ –û—Ç–∫—Ä—ã—Ç—å –ü–∞–Ω–µ–ª—å –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è", web_app: { url: WEB_APP_URL } }]
            ]
        }
    });
});

bot.on('web_app_data', (msg) => {
    try {
        const chatId = msg.chat.id;
        const data = JSON.parse(msg.web_app_data.data);
        console.log(`–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ Web App –æ—Ç ${chatId}:`, data);

        const session = getOrCreateSession(chatId);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Å—Å–∏–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –æ—Ç Web App
        session.settings.model = data.model || session.settings.model;
        session.settings.iteration_count = data.iterations || session.settings.iteration_count;
        session.settings.enabled_networks = data.enabled_networks || session.settings.enabled_networks;
        session.settings.temperature = data.temperature || session.settings.temperature;
        session.settings.max_tokens = data.max_tokens || session.settings.max_tokens;
        
        session.startCollaboration(data.topic);

    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Web App:", error);
        bot.sendMessage(msg.chat.id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.");
    }
});

bot.onText(/\/stop/, (msg) => {
    const session = chatSessions[msg.chat.id];
    if (session && session.isWorking) {
        session.isWorking = false;
        bot.sendMessage(msg.chat.id, "üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏. –ó–∞–≤–µ—Ä—à–∞—é —Ç–µ–∫—É—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é...");
    } else {
        bot.sendMessage(msg.chat.id, "–°–µ–π—á–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±—Å—É–∂–¥–µ–Ω–∏—è.");
    }
});

bot.onText(/\/reset/, (msg) => {
    delete chatSessions[msg.chat.id];
    bot.sendMessage(msg.chat.id, "üóëÔ∏è –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞ —Å–±—Ä–æ—à–µ–Ω—ã.");
});

bot.on('polling_error', (error) => {
    console.error(`–û—à–∏–±–∫–∞ Polling: [${error.code}] ${error.message}`);
});

const app = express();
const PORT = process.env.PORT || 3000; 
const HOST = '0.0.0.0';

app.get('/', (req, res) => res.send('–ë–æ—Ç –∂–∏–≤ –∏ –∑–¥–æ—Ä–æ–≤!'));

app.listen(PORT, HOST, () => {
    console.log(`–í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è health check –£–°–ü–ï–®–ù–û –∑–∞–ø—É—â–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç ${HOST}:${PORT}`);
});